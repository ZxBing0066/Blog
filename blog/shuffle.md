# å†™äº†ä¸ªä¹±åºï¼Œå¯æˆ‘ä¸çŸ¥é“å®ƒå¤Ÿä¸å¤Ÿä¹±ï¼Œå’‹æ•´

å‡ ä¸ªæœˆå‰å› ä¸ºæŸä¸ªéœ€æ±‚ï¼Œéœ€è¦å†™ä¸€ä¸ªä¹±åºå‡½æ•°ï¼Œäºæ˜¯ä¹å°±æ’¸äº†ä¸€ä¸ªï¼Œç„¶è€Œæ’¸å®Œåˆå¼€å§‹æ€è€ƒï¼Œæ€ä¹ˆè¯æ˜ç»“æœå¤Ÿä¸å¤Ÿä¹±å‘¢ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹ã€‚

> åˆ«é—®ä¸ºå•¥è¦é‡å¤é€ è¿™ä¹ˆå°çš„è½®å­ï¼Œå°±æ˜¯æ²¡å†™è¿‡éšä¾¿å†™å†™ã€‚

## æ€ä¹ˆå†™ä¹±åºå‡½æ•°

å…ˆå®šä¹‰ä¸€ä¸‹æˆ‘ä»¬çš„ä¹±åºå‡½æ•°ï¼Œé¦–å…ˆå®ƒæ”¯æŒæ¥å—ä¸€ä¸ªæ•°ç»„æˆ–ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç„¶åä¼šå°†æ•°ç»„æˆ–å­—ç¬¦ä¸²ä¸­çš„å…ƒç´ ä¹±åºè¾“å‡ºã€‚

ä»£ç ä½¿ç”¨ `TS` ç¼–å†™ï¼Œå…ˆå®šä¹‰æ¥å£ï¼š

```ts
function shuffle(target: string): string;
function shuffle<T = any>(target: T[]): T[];
```

ä¸ºäº†å…¼å®¹ä¸¤ç§æ•°æ®ç±»å‹ä¸”æœ‰è‰¯å¥½çš„ç±»å‹æ¨æ–­ï¼Œè¿™é‡Œä½¿ç”¨äº†é‡è½½ã€‚

å®ç°å¾ˆç®€å•ï¼Œå¦‚æœä¸ºå­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå°†å…¶è½¬æ¢ä¸ºæ•°ç»„ï¼›å¦‚æœæ˜¯æ•°ç»„ï¼Œä¸ºäº†é¿å…å½±å“åŸæ•°ç»„ï¼Œå°± `clone` ä¸€ä»½ï¼š

```ts
const isString = typeof target === 'string';
let shuffleTarget: T[] | string[];
if (isString) {
    shuffleTarget = target.split('');
} else {
    shuffleTarget = target.slice();
}
```

éšåå‘¢ï¼Œæˆ‘ä»¬å°†æ•°ç»„ä¸­çš„å…ƒç´ è¿›è¡Œæ‰“ä¹±ï¼Œæ‰“ä¹±çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œæˆ‘è¿™é‡Œé€‰æ‹©æ¯æ¬¡ä»æ•°ç»„ä¸­éšæœºä¸€ä¸ªå…ƒç´ ç„¶åå°†å…¶æ”¾åˆ°æœ€æœ«ç«¯ï¼Œç„¶åæ¯æ¬¡å°†æœ«ç«¯ç´¢å¼•å‘å‰ç§»åŠ¨ï¼Œè¿™æ ·å³å¯ä¿è¯ä¸€ä¸ªå…ƒç´ åªè¢«æ“ä½œä¸€æ¬¡ã€‚

```ts
const randomIndex = (l: number) => Math.floor(Math.random() * l);

let l = shuffleTarget.length;
while (l) {
    let i = randomIndex(l--);
    const tmp = shuffleTarget[i];
    shuffleTarget[i] = shuffleTarget[l];
    shuffleTarget[l] = tmp;
}
```

è¿™ç§æ–¹å¼ä¹‹ååœ¨ `lodash` æ–‡æ¡£ä¸­çœ‹åˆ°ï¼Œå«åš [Fisherâ€“Yates_shuffle](https://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle)ã€‚

å½“ç„¶ä¹±åºè¿˜æœ‰å¾ˆå¤šç§åŠæ³•ï¼Œæ¯”å¦‚ï¼š

-   åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„ï¼Œæ¯æ¬¡éšæœºä»æ•°ç»„ä¸­é€‰å–ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åå°†å…¶ä¸¢å…¥æ–°æ•°ç»„ä¸­
-   ä½¿ç”¨ `sort` éšæœºè¿”å› -1 æˆ– 1
-   æˆ–è€…æ¯æ¬¡éšæœºä¸¤ä¸ªç´¢å¼•åè®©å®ƒä»¬äº¤æ¢ä½ç½®

ä¸è¿‡ç»¼åˆçœ‹ä¸‹æ¥ï¼Œè¿˜æ˜¯ä¸Šè¿°çš„æ–¹æ¡ˆæ€§èƒ½æ›´é«˜ï¼ˆè¿˜æœ‰æ”¹è¿›çš„åœ°æ–¹ï¼Œæ¯”å¦‚ `l` ä¸º 1 æ—¶å°±å¯é€€å‡ºäº†ï¼Œä¸è¿‡æ— ä¼¤å¤§é›…ï¼‰ï¼Œæ•ˆæœæœ€å¥½ã€‚

## é—®é¢˜å‡ºç°

è¿™ä¹ˆå°çš„ä¸€ä¸ªä¹±åºï¼Œå’‹è¿˜èƒ½å‡ºé—®é¢˜å‘¢ï¼Œåˆ«æ€¥ï¼ŒçœŸä¸æ˜¯æˆ‘èœ ğŸ¶ï¼Œä¸»è¦æ˜¯å­—ç¬¦ä¸²å¤ªéªšã€‚

å¤§å®¶åº”è¯¥éƒ½çŸ¥é“ï¼Œå¾ˆå¤šå­—ç¬¦ä¸²é•¿åº¦ä¸ä¸º 1ï¼Œä¸»è¦å°±æ˜¯å› ä¸ºå®ƒè¶…å‡ºäº† `Unicode` ç¼–ç å•å­—ç¬¦çš„èŒƒå›´ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨å¤šä¸ª `Unicode` ç¼–ç åŒºæ¥è¡¨ç¤ºï¼Œè€Œå¤§éƒ¨åˆ†è¯­è¨€ä¸­çš„é•¿åº¦ï¼Œéƒ½æ˜¯ `Unicode` ç¼–ç å•å­—ç¬¦çš„é•¿åº¦ã€‚æœ€å¸¸è§çš„å°±æ˜¯ `emoji` äº†ï¼Œæ¯”å¦‚ ğŸ‘·â€â™€ï¸ è¿™ä¸ª `emoji`ï¼Œå®ƒçš„ `length` å°±æ˜¯ 5ï¼Œè¿™å¸¦æ¥çš„é—®é¢˜ä¸åªæ˜¯ä¼šå‡ºç°åœ¨å­—ç¬¦é•¿åº¦ä¸­ï¼Œè¿˜å‡ºç°åœ¨å­—ç¬¦ä¸²åˆ†å‰²ä¸­ï¼Œä¸Šé¢æˆ‘ä»¬ä½¿ç”¨ `split('')` æ¥åˆ†å‰²å­—ç¬¦ä¸²ï¼Œå°±ä¼šå¯¼è‡´è¿™ä¸ª `emoji` è¢«åˆ†å‰²ä¸º ['\uD83D', '\uDC77', 'â€', 'â™€', 'ï¸'] è¿™ 5 ä¸ªå­—ç¬¦ï¼Œæ˜¾ç„¶å¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚

æ¯”è¾ƒç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ `Array.from` æˆ–æ•°ç»„è§£æ„æ¥æ‹†è§£å­—ç¬¦ä¸²ï¼Œä½†æ˜¯ä»–åªèƒ½æ‹†è§£æ¯”è¾ƒç®€å•çš„ `emoji`ï¼Œå¦‚ 'ğŸ“¦' å¯ä»¥æˆåŠŸï¼Œä½†æ˜¯é‡åˆ°ä¸Šé¢çš„ 'ğŸ‘·â€â™€ï¸' ä¾æ—§è¦èººï¼ŒğŸ¤¦â€â™‚ï¸ è¿™ä¸ªå°±è¶…çº²äº†ï¼Œ éœ€è¦é…åˆä¸“ä¸šåº“æ¥è§£å†³ã€‚

## æ€ä¹ˆè¯æ˜å®ƒå¤Ÿä¹±

å†™å®Œéšä¹‹è€Œæ¥çš„ä¸€ä¸ªé—®é¢˜ä¾¿æ˜¯ï¼Œæ€ä¹ˆè¯æ˜è¿™ä¸ªå‡½æ•°å¤Ÿä¸å¤Ÿä¹±å‘¢ï¼Œè™½ç„¶ä»£ç çœ‹ç€æ²¡æ¯›ç—…ï¼Œä½†æ˜¯å’±è¿˜æ˜¯å¾—é æ•°æ®è¯´è¯ã€‚

äºæ˜¯ä¹ï¼Œæˆ‘æƒ³åˆ°å°†ä¸€ç»„æ•°æ®ä¹±åºä¸Šä¸‡æ¬¡ï¼Œç„¶åå°†ä¹±åºåçš„æ•°æ®åˆ†å¸ƒç»Ÿè®¡å‡ºæ¥è¿™ä¸ªåŠæ³•ã€‚å’±å…ˆä¸Šå›¾çœ‹çœ‹æ•ˆæœï¼š

![](https://github.com/ZxBing0066/zlib/raw/master/packages/shuffle/shuffle-distribution-chart.png)

è¿™æ˜¯æˆ‘å°† `A-P` 16 ä¸ªå­—æ¯è¿›è¡Œ 10W æ¬¡ä¹±åºï¼Œç„¶åç»Ÿè®¡å‡ºæ¥çš„åˆ†å¸ƒå›¾è¡¨ã€‚æˆ‘ä¸ºæ¯ä¸ªå­—æ¯ç”Ÿæˆäº†ä¸€ä¸ªé¢œè‰²ï¼Œç„¶åæ¨ªåæ ‡æ˜¯æ¯ä¸ªç´¢å¼•å’Œå‡ºç°åœ¨è¯¥ç´¢å¼•å¤„çš„å­—ç¬¦ï¼Œçºµåæ ‡ä¸ºå¯¹åº”çš„æ¬¡æ•°ã€‚

ä»å›¾è¡¨å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ªå­—æ¯å‡ºç°åœ¨æ¯ä¸ªç´¢å¼•ä½ç½®çš„æ¬¡æ•°åŸºæœ¬ç›¸åŒï¼Œéƒ½åœ¨ 6250 å·¦å³ï¼ˆ100000/6ï¼‰ï¼Œæ²¡æœ‰å‡ºç°åˆ†å¸ƒä¸å‡çš„æƒ…å†µï¼Œç”±æ­¤å¯è§ï¼Œæœç„¶å¤Ÿä¹±ã€‚ğŸ¶

å†é¡ºæ‰‹è´´ä¸Šå›¾è¡¨çš„[åœ°å€](https://codesandbox.io/s/z-shuffle-distribution-chart-2j33q?fontsize=14&hidenavigation=1&theme=dark&file=/src/index.js)å’Œä»£ç ï¼š

```js
import shuffle from 'z-shuffle';

const LetterCount = 16;
let t = 100000;
const chartCodeOfA = 'A'.charCodeAt(0);
const array = new Array(LetterCount).fill(null).map((v, i) => String.fromCharCode(i + chartCodeOfA));

const distributionMap = {};
for (const letter of array) {
    distributionMap[letter] = new Array(LetterCount).fill(0);
}

while (t--) {
    const arrayAfterShuffle = shuffle(array);
    for (const index in arrayAfterShuffle) {
        const letter = arrayAfterShuffle[index];
        distributionMap[letter][index]++;
    }
}

const datasets = [];
const l = Object.keys(distributionMap).length;
const d = Math.floor(255 / l);
for (const key in distributionMap) {
    const distribution = distributionMap[key];
    const code = key.charCodeAt(0) - chartCodeOfA;
    datasets.push({
        label: key,
        data: distribution,
        backgroundColor: `rgb(${d * code}, ${255 - d * code}, ${255 - code})`
    });
}

const data = {
    labels: new Array(l).fill(null).map((v, i) => i),
    datasets
};

const config = {
    type: 'bar',
    data: data,
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'right'
            }
        }
    }
};

new window.Chart(document.getElementById('myChart'), config);
```

## benchmark

ä¹±æ˜¯å¤Ÿä¹±äº†ï¼Œé‚£å°±é¡ºæ‰‹å†æµ‹è¯•ä¸‹æ€§èƒ½å¥½äº†ï¼Œå…·ä½“ä»£ç å¯ä»¥çœ‹ä¸‹ [benchmark.js](https://github.com/ZxBing0066/zlib/blob/master/packages/shuffle/benchmark.js) å°±ä¸è´´äº†ï¼Œè´´ä¸‹æµ‹è¯•ç»“æœã€‚

```sh
 lodash/shuffle:
    1 357 426 ops/s, Â±1.60%   | slowest, 26.89% slower

  array-shuffle:
    1 856 774 ops/s, Â±0.64%   | fastest

  shuffle-array:
    1 807 762 ops/s, Â±1.66%   | 2.64% slower

  z-shuffle:
    1 792 127 ops/s, Â±0.61%   | 3.48% slower

  z-shuffle pure=false:
    1 769 492 ops/s, Â±1.22%   | 4.7% slower
```

åŸºæœ¬ä¸Šæµ‹ä¸‹æ¥æ€§èƒ½éƒ½å·®ä¸å¤šï¼Œå› ä¸ºæˆ‘è¿™é‡Œè¿˜æœ‰å‡ ä¸ªå‚æ•°åˆ¤æ–­ï¼Œä»¥åŠåˆšåˆšä¸Šé¢è¯´åˆ°çš„å¾ªç¯å¤šäº†ä¸€æ¬¡ï¼Œæ‰€ä»¥ç¨å¾®æ…¢ä¸€ä¸¢ä¸¢ï¼Œä¸è¿‡ `lodash` è¿™ã€‚ã€‚ã€‚

æœ€åå¹å˜˜ä¸€æ³¢ï¼šæœ¬åº“ `ts` ç¼–å†™ï¼Œ`MIT` åè®®ï¼Œå°ºå¯¸ä¸åˆ° 400Bï¼Œæ— ä¾èµ–ï¼Œ100% æµ‹è¯•è¦†ç›–ç‡ï¼Œæ”¯æŒ `tree-sharking`ï¼Œæ”¯æŒ `worker`ï¼Œæ”¯æŒ `esm`ã€`cjs`ã€`umd` å„ç§ï¼Œæ”¯æŒå­—ç¬¦ä¸²å’Œæ•°ç»„ï¼Œç«¥åŸæ— æ¬ºï¼Œæ¬¢è¿ä½¿ç”¨ã€‚ğŸ¶ ä¿å‘½ã€‚

å¥½äº†æœ¬ç¯‡æ°´æ–‡åˆ°æ­¤ä¸ºæ­¢ï¼Œé¡ºæ‰‹è´´ä¸‹è¯¥åº“çš„ [`github` åœ°å€](https://github.com/ZxBing0066/zlib/tree/master/packages/shuffle)ï¼Œæ¬¢è¿å¤§å®¶ä¸‰è¿ ğŸ¶ã€‚
